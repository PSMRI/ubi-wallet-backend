name: Deploy to UBA-DEV Image

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Docker tag to deploy (e.g., v1.0.4)'
        required: true
        default: 'latest'

jobs:
  deploy_on_uba_dev:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment: UBA-DEV  # ðŸ‘ˆ Secrets come from this environment

    steps:
      - name: Set environment variables
        id: vars
        run: |
          IMAGE_NAME=$(echo "ghcr.io/${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          TAG="${{ github.event.inputs.tag }}"
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "IMAGE_URI=$IMAGE_NAME:$TAG" >> $GITHUB_ENV
          echo "ðŸ“¦ Image to deploy: $IMAGE_NAME:$TAG"

      - name: Deploy to UBA-DEV server
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.HOST_NAME }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            set -e
            echo "ðŸš€ Starting deployment to UBA-DEV environment"
            
            IMAGE_URI="${{ env.IMAGE_URI }}"
            CONTAINER_NAME="ubi-wallet-backend"
            BASE_DIR="${{ secrets.TARGET_DIR }}"
            ENV_FILE="${BASE_DIR}/.env"

            echo "ðŸ“¦ Pulling image from GHCR: $IMAGE_URI"
            docker pull "$IMAGE_URI"

            echo "ðŸ›‘ Stopping and removing existing container if running..."
            docker rm -f "$CONTAINER_NAME" || true

            echo "ðŸš€ Starting new container..."
            docker run -d \
              --name "$CONTAINER_NAME" \
              --env-file "$ENV_FILE" \
              -p 80:80 \
              "$IMAGE_URI"

            echo "âœ… Deployment complete! Showing running containers:"
            docker ps | grep "$CONTAINER_NAME"

      - name: Notify on Slack
        uses: iRoachie/slack-github-actions@v2.3.2
        if: ${{ always() }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          status: ${{ job.status }}
